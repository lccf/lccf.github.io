---
title: devise使用ajax登录
date: 2013-12-18 18:29
tags:
- devise配置json
- devise配置ajax
- devise ajax 登录
- devise ajax signin
categories: 积累点滴
---

devise默认已经有较好的ajax支持了，只需要简单的配置一下即可使用ajax登录/注册。

1.修改config/application.rb加下以下配置，启用json输出。

```ruby
# devise respond_to json
config.to_prepare do
  DeviseController.respond_to :html, :json
end
```

2.修改form标签，添加data-remote, data-type，设置id

```html
<%= form_for(resource, :as => resource_name, :url => session_path(resource_name), :remote => true,
 html: {id: 'ajax_user_signin', data: {type: :json}}) do |f| %>
```

3.设置ajax头

```javascript
$.ajaxSetup({
  beforeSend: function(xhr){
    var token;
    token = $('meta[name="csrf-token"]').attr('content');
    if (token) {
      xhr.setRequestHeader('X-CSRF-Token', token);
    }
  }
});
```
4.js处理代码

```javascript
$('#ajax_user_signin').on('ajax:complete', function(e, xhr, type){
  if (type === 'success') {
    location.href = '/';
  } else {
    try {
      alert(xhr.responseJSON.error);
      // this.reset();
    } catch (e$) {
      e = e$;
    }
  }
});
```

关于注册：
注册的方法和登录基本相同，给form_for添加data-remote、data-type和id等属性。需要注意的是注册返回的表单验证是多项错误，使用xhr.resonseJSON.errors获取错误集合。